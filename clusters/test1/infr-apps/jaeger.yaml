apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: k8s-spb2-backend1-jaeger
  namespace: argocd
  annotations:
    argocd.argoproj.io/sync-wave: "3"
spec:
  syncPolicy:
    automated:
      prune: false
    syncOptions:
    - CreateNamespace=true
    - FailOnSharedResource=false
  project: default
  destination:
    name: kind-test-1
    namespace: jaeger
  sources:
    - repoURL: 'https://github.com/nomad-mrkn/zargocd.git'
      targetRevision: HEAD
      path: shared/jit-rbac
      kustomize:
        commonLabels:
          jit-rbac/app: k8s-spb2-backend1-jaeger
        patches:
          - target:
              kind: ClusterRole
            patch: |-
              - op: replace
                path: /metadata/name
                value: argocd-manager-jaeger
          - target:
              kind: ClusterRoleBinding
            patch: |-
              - op: replace
                path: /metadata/name
                value: argocd-manager-jaeger
              - op: replace
                path: /roleRef/name
                value: argocd-manager-jaeger
          - target:
              kind: CronJob
            patch: |-
              - op: replace
                path: /metadata/name
                value: k8s-spb2-backend1-jaeger-cleanup-cron
          - target:
              kind: Job
            patch: |-
              - op: replace
                path: /metadata/name
                value: k8s-spb2-backend1-jaeger-cleanup
    - repoURL: 'https://github.com/nomad-mrkn/zargocd.git'
      targetRevision: HEAD
      path: shared/jit-rbac-roles
      directory:
        include: jaeger-role.yaml
    - repoURL: 'https://github.com/nomad-mrkn/charts.git'
      targetRevision: HEAD
      path: jaeger-operator
      helm:
        releaseName: k8s-spb2-backend1-jaeger
        values: |
          jaeger:
            strategy: production
                allInOne:
                  options: # <3>
                    log-level: debug # <4>
                ingress:
                  enabled: false
                agent:
                  resources:
                    limits:
                     cpu: 2000m
                     memory: 1024Mi
                    requests:
                     cpu: 200m
                     memory: 128Mi
                  sidecarSecurityContext:
                    allowPrivilegeEscalation: false
                    capabilities:
                      drop:
                        - ALL
                    runAsNonRoot: true
                    runAsUser: 1001
                    runAsGroup: 1001
                    seccompProfile:
                      type: RuntimeDefault
                  image: ghcr.io/jaegertracing/jaeger-agent:1.49.0
                query:
                  resources:
                    requests:
                     cpu: 100m
                     memory: 128Mi
                    limits:
                      cpu: 2000m
                      memory: 512Mi
                  image: ghcr.io/jaegertracing/jaeger-query:1.49.0
                  tolerations:
                  - key: "node-role.kubernetes.io/infr"
                    operator: "Exists"
                    effect: "NoSchedule"
                  affinity:
                    nodeAffinity:
                      preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 1
                          preference:
                            matchExpressions:
                            - key: "node-role.kubernetes.io/infr"
                              operator: "Exists"
                collector:
                  minReplicas: 24
                  maxReplicas: 24
                  image: ghcr.io/jaegertracing/jaeger-collector:1.49.0
                  options:
                    collector:
                      num-workers: 2000
                      queue-size: 50000
                  resources:
                    requests:
                      cpu: 2000m
                      memory: 1536Mi
                    limits:
                      cpu: 3000m
                      memory: 2Gi
                  tolerations:
                  - key: "node-role.kubernetes.io/infr"
                    operator: "Exists"
                    effect: "NoSchedule"
                  affinity:
                    nodeAffinity:
                      preferredDuringSchedulingIgnoredDuringExecution:
                        - weight: 1
                          preference:
                            matchExpressions:
                            - key: "node-role.kubernetes.io/infr"
                              operator: "Exists"
                storage:
                  type: cassandra
                  options:
                    cassandra:
                      servers: cassandra-jaeger1.spb.dc,cassandra-jaeger2.spb.dc,cassandra-jaeger3.spb.dc
                      keyspace: jaeger_v1_ru_spb
                  cassandraCreateSchema:
                    enabled: false
                  dependencies:
                    enabled: false
                  secretName: jaeger-secret
          rbac:
            create: true
            pspEnabled: false
            clusterRole: true
          resources:
            limits:
              cpu: 2
              memory: 512Mi
            requests:
              cpu: 1
              memory: 256Mi
          nodeSelector: {}
          tolerations:
          - key: "node-role.kubernetes.io/infr"
            operator: "Exists"
            effect: "NoSchedule"
          affinity:
            nodeAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
                - weight: 1
                  preference:
                    matchExpressions:
                    - key: "node-role.kubernetes.io/infr"
                      operator: "Exists"
          vault:
            - name: jaeger-secret
              path: secret/internal/infrastructure/Cassandra/jaeger/prod
              type: Opaque
