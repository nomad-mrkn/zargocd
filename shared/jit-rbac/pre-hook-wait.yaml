apiVersion: batch/v1
kind: Job
metadata:
  name: APP_NAME_PLACEHOLDER-rbac-waiter
  namespace: kube-system
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded,HookFailed
    argocd.argoproj.io/sync-wave: "1"
  labels:
    app.kubernetes.io/part-of: argo-jit-rbac
    jit-rbac/app: APP_NAME_PLACEHOLDER
spec:
  backoffLimit: 10
  activeDeadlineSeconds: 180
  ttlSecondsAfterFinished: 60
  template:
    metadata:
      labels:
        app.kubernetes.io/part-of: argo-jit-rbac
        jit-rbac/app: APP_NAME_PLACEHOLDER
    spec:
      serviceAccountName: argocd-manager
      restartPolicy: OnFailure
      containers:
      - name: wait-rbac
        image: bitnami/kubectl:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: JIT_RBAC_APP
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['jit-rbac/app']
        - name: TIMEOUT_SECONDS
          value: "180"
        - name: CHECK_INTERVAL
          value: "2"
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -euo pipefail
            echo "Waiting for ClusterRole rules to be populated for ${JIT_RBAC_APP}..."
            
            ROLE_NAME=$(kubectl get clusterrole -l app.kubernetes.io/part-of=argo-jit-rbac,jit-rbac/app=${JIT_RBAC_APP} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
            
            if [ -z "${ROLE_NAME}" ]; then
              echo "ERROR: ClusterRole not found for ${JIT_RBAC_APP}"
              exit 1
            fi
            
            echo "Found ClusterRole: ${ROLE_NAME}"
            
            ELAPSED=0
            while [ ${ELAPSED} -lt ${TIMEOUT_SECONDS} ]; do
              RULES=$(kubectl get clusterrole "${ROLE_NAME}" -o jsonpath='{.rules}' 2>/dev/null || echo "[]")
              
              if [ "${RULES}" != "[]" ] && [ -n "${RULES}" ]; then
                RULES_COUNT=$(echo "${RULES}" | grep -o "apiGroups" | wc -l || echo "0")
                if [ ${RULES_COUNT} -gt 0 ]; then
                  echo "✓ ClusterRole '${ROLE_NAME}' has ${RULES_COUNT} rule groups - READY"
                  
                  CRB_NAME=$(kubectl get clusterrolebinding -l app.kubernetes.io/part-of=argo-jit-rbac,jit-rbac/app=${JIT_RBAC_APP} -o jsonpath='{.items[0].metadata.name}' 2>/dev/null || echo "")
                  if [ -n "${CRB_NAME}" ]; then
                    echo "✓ ClusterRoleBinding '${CRB_NAME}' exists - READY"
                  else
                    echo "⚠ ClusterRoleBinding not found, but ClusterRole is ready"
                  fi
                  
                  exit 0
                fi
              fi
              
              echo "⏳ ClusterRole '${ROLE_NAME}' rules not ready yet (attempt $((ELAPSED / CHECK_INTERVAL + 1)))"
              sleep ${CHECK_INTERVAL}
              ELAPSED=$((ELAPSED + CHECK_INTERVAL))
            done
            
            echo "ERROR: Timeout waiting for ClusterRole rules after ${TIMEOUT_SECONDS}s"
            kubectl get clusterrole "${ROLE_NAME}" -o yaml || true
            exit 1

